# 案件分析のバッチ集計化 計画

## 現状の課題

- **分析画面**で直近20日分の**全案件**をサーバーから取得し、クライアントに送っている
- クライアント側で以下を計算している：
  - 日別案件数（日付ごとの件数）
  - スキル別案件数（Top 20）
  - ポジション別案件数
  - 単価分布（管理者のみ）
- データ量が増えると初期表示が重く、ブラウザ負荷も大きい

## 方針

**集計はバッチで行い、結果だけをDBに保存する。画面はその結果を読んで表示するだけにする。**

- サーバーは「集計済み結果」だけを返す → レスポンスが軽い
- クライアントは集計ロジックを持たず、表示だけ → 軽い
- 集計の実行タイミングは「定期バッチ」に寄せる

---

## 1. データベース

### 1.1 集計結果用テーブル

集計結果を保存するテーブルを1つ用意する（期間ごとに1行）。

| テーブル名（案） | 説明 |
|------------------|------|
| `JobAnalyticsSnapshot` | 案件の集計スナップショット（期間タイプごとに1行） |

**カラム案**

| カラム | 型 | 説明 |
|--------|-----|------|
| `id` | String (cuid) | 主キー |
| `period` | String | 期間タイプ: `7d` / `30d` / `90d` / `all` |
| `aggregatedAt` | DateTime | 集計実行日時 |
| `totalCount` | Int | 総案件数 |
| `dailyStats` | Json | 日別件数 `[["2025/1/1", 10], ...]` |
| `skillStats` | Json | スキル別件数 Top20 `[["React", 50], ...]` |
| `positionStats` | Json | ポジション別件数 `[["SE", 30], ...]` |
| `priceStats` | Json? | 単価分布（管理者用） `[["40万円未満", 5], ...]` |

- `period` + 集計の一意性が必要なら `period` にユニークを張り、「毎回 upsert」する形でもよい
- 履歴を残したい場合は `period` をユニークにせず、`aggregatedAt` で「最新1件」を取る

**シンプル案（推奨）**: `period` をユニークにして、バッチは「4件を upsert」するだけ。画面は `period` で1件取得する。

---

## 2. バッチ

### 2.1 実行場所の候補

| 方式 | メリット | デメリット |
|------|----------|------------|
| **A. Vercel Cron + API** | 既存の Next に寄せられる | 実行時間制限・Cold start |
| **B. GAS から API 呼び出し** | 既存の GAS トリガーで定期実行しやすい | 集計ロジックを API 側に持つ必要あり |
| **C. 外部 Cron + スクリプト** | 制約が少ない | サーバー or 手動実行の用意が必要 |

**推奨**: **A. Vercel Cron**  
- `vercel.json` で `GET /api/cron/analytics` を 1日1回などにスケジュール
- その API 内で Prisma で Job を読んで集計し、`JobAnalyticsSnapshot` に upsert
- 集計ロジックはすべてサーバー側にまとまる

### 2.2 バッチの処理内容

1. 現在の `AnalyticsClient` と同じ集計ロジックを**サーバー側（API または server action）**に移植する：
   - 7日 / 30日 / 90日 / 全期間の4パターンで、それぞれ
     - 対象期間の Job を `receivedAt` でフィルタ
     - 日別件数・スキル別・ポジション別・単価分布を計算
2. 結果を `JobAnalyticsSnapshot` に **upsert**（`period` をキーに 4 件を更新）
3. 実行日時を `aggregatedAt` に保存

### 2.3 初回・未実行時

- バッチがまだ1回も動いていないときは `JobAnalyticsSnapshot` が空
- 画面側は「データがありません。しばらくお待ちください」などと表示
- または「今すぐ集計」ボタンを用意し、手動で同じ API を叩いて1回だけ実行できるようにする

---

## 3. 画面（Next.js）

### 3.1 分析ページ（Server Component）

- **現状**: 全案件を取得して `AnalyticsClient` に渡している
- **変更後**:
  - クエリパラメータまたはデフォルトで `period`（`7d` / `30d` / `90d` / `all`）を決める
  - `JobAnalyticsSnapshot` を `period` で 1 件取得
  - 取得した `totalCount`, `dailyStats`, `skillStats`, `positionStats`, `priceStats` をそのままクライアントに渡す
  - データが無い場合は「集計結果がありません」を表示

### 3.2 AnalyticsClient（Client Component）

- **現状**: `jobs` を受け取り、`useMemo` で日別・スキル別・ポジション別・単価を計算している
- **変更後**:
  - props を「集計済みデータ」に変更（`totalCount`, `dailyStats`, `skillStats`, `positionStats`, `priceStats`）
  - 集計用の `useMemo` は**すべて削除**
  - 期間切り替え時は `?period=30d` のように URL を変えてサーバーに再取得させる（または 4 期間分をまとめて渡してクライアントで切り替えだけする）
  - 表示ロジック（グラフ・棒グラフ・サマリーカード）はそのまま流用

### 3.3 期間切り替え

- **案1（URL 駆動）**: セレクトで `period` を変えたら `router.push('/analytics?period=30d')` などにして、サーバーで該当 `period` のスナップショットを取得し直す。実装が単純で、常に「最新の集計結果」を表示できる。
- **案2（4期間まとめて取得）**: 分析ページで 4 期間分のスナップショットをまとめて取得し、クライアントには全部渡す。期間切り替えは state だけ。通信は1回で済むが、初回取得がやや重くなる。

**推奨**: まずは **案1（URL 駆動）** で進める。

---

## 4. 実装ステップ案

| 順番 | 内容 |
|------|------|
| 1 | Prisma に `JobAnalyticsSnapshot` を追加し、マイグレーション実行 |
| 2 | 集計ロジックをサーバー側に移植（API Route または server action）: `POST /api/analytics/aggregate` など |
| 3 | Vercel Cron（または GAS）からその API を定期実行する設定 |
| 4 | 分析ページを「スナップショット取得 + 渡すだけ」に変更 |
| 5 | AnalyticsClient の props を集計済みデータにし、クライアント側の集計 `useMemo` を削除 |
| 6 | 期間切り替えを URL パラメータ（`period`）で行うように変更 |
| 7 | 未集計時・エラー時の表示を追加（「データがありません」など） |

---

## 5. 補足

- **リアルタイム性**: 集計はバッチの実行間隔（例: 1日1回）で更新される。即時反映はしない想定。
- **単価分布**: 管理者用のため、バッチは「全ユーザー向け＋管理者向け」の両方の集計を同じスナップショットに入れておき、画面側で権限に応じて `priceStats` を出すかどうかだけ切り替えればよい。
- **既存の「直近20日」**: 分析は「7/30/90/全期間」の4種なので、直近20日の制限はバッチ側では不要。集計対象は「全 Job」でよい（必要ならバッチ内で日付フィルタのみ行う）。

この計画で進めれば、分析画面は「軽いレスポンス＋表示だけ」になり、バッチでデータ分析して結果だけDBに入れて表示する形にできます。
