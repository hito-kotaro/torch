# キーワード調整方法

このドキュメントでは、メールの事前フィルタリングで使用するキーワードの調整方法を説明します。

## 概要

`torch-batch.js`では、メールを処理する前にキーワードベースのフィルタリングを行い、**案件メールのみ**を処理対象とします。人材メールやその他のメールは事前にスキップすることで、Gemini API の呼び出し回数を削減します。

## キーワードの構造

キーワードは重み付けされており、以下の 3 つのカテゴリに分類されます：

### 案件キーワード（`JOB_KEYWORDS`）

案件メールの可能性を示すキーワードです。

- **`high`**: 高重みキーワード（案件の可能性が非常に高い）
  - スコア: 3 点
  - 例: 「エンド直案件」「現場直案件」「案件」「単価変更」
- **`medium`**: 中重みキーワード
  - スコア: 2 点
  - 例: 「開発」「システム」「運用保守」
- **`low`**: 低重みキーワード（技術名など、案件と人材の両方に出現）
  - スコア: 1 点
  - 例: 「AWS」「React」「Java」

### 人材キーワード（`TALENT_KEYWORDS`）

人材メールの可能性を示すキーワードです。これらのキーワードが多く含まれるメールは処理対象外となります。

- **`high`**: 高重みキーワード（人材の可能性が非常に高い）
  - スコア: 3 点
  - 例: 「ご紹介」「要員情報」「要員」「個人事業主」
- **`medium`**: 中重みキーワード
  - スコア: 2 点
  - 例: 「ご提案」「候補者」「プロフィール」
- **`low`**: 低重みキーワード
  - スコア: 1 点
  - 例: 「ご連絡」「お問い合わせ」

### 除外キーワード（`EXCLUDE_KEYWORDS`）

明らかに案件でも人材でもないメールを示すキーワードです。

- 例: 「会議」「ミーティング」「打ち合わせ」「調整」「お疲れ様」

## フィルタリングロジック

`shouldProcessMail()`関数では、以下のロジックでメールを判定します：

1. **除外キーワードチェック**

   - 除外キーワードが含まれている場合、案件キーワード（高重み）も含まれていなければスキップ

2. **人材スコア計算**

   - 人材キーワードの重みを合計
   - **人材スコアが 3 点以上**の場合、人材メールとして判定し、処理対象外とする

3. **案件スコア計算**
   - 案件キーワードの重みを合計
   - **案件スコアが 2 点以上**の場合、案件メールとして判定し、処理対象とする

## キーワードの調整方法

### 1. キーワードの追加

`torch-batch.js`の該当箇所を編集します。

```javascript
var JOB_KEYWORDS = {
  high: [
    "エンド直案件",
    "現場直案件",
    // ここに新しいキーワードを追加
    "新規キーワード",
  ],
  medium: [
    // 中重みキーワードを追加
  ],
  low: [
    // 低重みキーワードを追加
  ],
};
```

### 2. キーワードの削除

不要になったキーワードを配列から削除します。

### 3. 重みの変更

キーワードの重要度に応じて、`high`、`medium`、`low`の間で移動させます。

**例**: 「React」を中重みに変更する場合

```javascript
// 変更前
low: ["React", "Vue", ...],

// 変更後
medium: ["React", ...],
low: ["Vue", ...],
```

### 4. スコア閾値の調整

`shouldProcessMail()`関数内の閾値を変更します。

```javascript
// 人材スコアの閾値（現在: 3点）
if (talentScore >= 3) {
  return false;
}

// 案件スコアの閾値（現在: 2点）
return jobScore >= 2;
```

**調整の目安**:

- 人材メールが誤って処理されている場合: 人材スコアの閾値を下げる（例: 3 → 2）
- 案件メールがスキップされている場合: 案件スコアの閾値を下げる（例: 2 → 1）

## キーワード調整の手順

### ステップ 1: サンプルデータの収集

実際のメールタイトルを 100 件〜1000 件程度収集します。

**収集方法**:

- Gmail から実際のメールタイトルをエクスポート
- 手動でリストアップ
- 既存のデータベースから抽出

### ステップ 2: データの分類

収集したメールタイトルを以下の 3 つに分類します：

1. **案件メール**: 処理対象としたいメール
2. **人材メール**: 処理対象外としたいメール
3. **その他**: どちらでもないメール

### ステップ 3: パターンの分析

分類したデータから、以下のパターンを抽出します：

- **案件メールに多く含まれるキーワード**
- **人材メールに多く含まれるキーワード**
- **両方に含まれるキーワード**（低重みに配置）

### ステップ 4: キーワードの追加・調整

分析結果に基づいて、キーワードを追加・調整します。

**例**: サンプルデータで「リモート案件」という表現が多く見つかった場合

```javascript
var JOB_KEYWORDS = {
  high: [
    "エンド直案件",
    "現場直案件",
    "リモート案件", // 追加
    // ...
  ],
};
```

### ステップ 5: テスト実行

調整後、実際のメールでテスト実行し、精度を確認します。

**確認ポイント**:

- 案件メールが正しく処理されているか
- 人材メールが正しくスキップされているか
- 誤判定が発生していないか

### ステップ 6: 閾値の微調整

テスト結果に基づいて、スコアの閾値を微調整します。

## よくある調整パターン

### パターン 1: 新しい案件タイプが増えた

**症状**: 新しい案件タイプのメールがスキップされている

**対応**:

1. その案件タイプに特徴的なキーワードを抽出
2. 案件キーワードの適切な重みカテゴリに追加

**例**: 「クラウド案件」という表現が増えた場合

```javascript
high: [
  "エンド直案件",
  "現場直案件",
  "クラウド案件", // 追加
],
```

### パターン 2: 人材メールが誤って処理されている

**症状**: 人材メールが案件として処理されている

**対応**:

1. 人材メールに特徴的なキーワードを抽出
2. 人材キーワードの高重みに追加
3. 人材スコアの閾値を下げる（例: 3 → 2）

**例**: 「ご紹介」というキーワードが人材メールに多く含まれる場合

```javascript
var TALENT_KEYWORDS = {
  high: [
    "ご紹介", // 既に含まれているが、確認
    "要員情報",
    // ...
  ],
};
```

### パターン 3: 技術名のみのメールタイトル

**症状**: 技術名のみのメールタイトルで判定が難しい

**対応**:

- 技術名は低重みキーワードとして配置
- 案件スコアの閾値を調整（例: 2 → 1）して、技術名のみでも処理対象とする
- ただし、人材メールにも技術名が含まれるため、慎重に調整

## キーワード追加のベストプラクティス

### 1. 具体的なキーワードを優先

曖昧なキーワードよりも、具体的で明確なキーワードを追加します。

**良い例**:

- 「エンド直案件」
- 「現場直案件」
- 「単価変更」

**悪い例**:

- 「情報」
- 「内容」
- 「詳細」

### 2. 重み付けを適切に設定

キーワードの重要度に応じて、適切な重みカテゴリに配置します。

- **高重み**: 案件/人材を明確に示すキーワード
- **中重み**: 案件/人材の可能性が高いキーワード
- **低重み**: 両方に出現する可能性があるキーワード（技術名など）

### 3. 定期的な見直し

メールの傾向が変わる可能性があるため、定期的にキーワードを見直します。

**推奨頻度**: 月 1 回程度、または新しいメールタイプが増えたタイミング

## トラブルシューティング

### Q: 案件メールがスキップされている

**A**: 以下の順序で確認・調整します：

1. 案件キーワードに該当メールの特徴的なキーワードが含まれているか確認
2. 含まれていない場合、適切な重みカテゴリに追加
3. 含まれている場合、案件スコアの閾値を下げる（例: 2 → 1）

### Q: 人材メールが処理されている

**A**: 以下の順序で確認・調整します：

1. 人材キーワードに該当メールの特徴的なキーワードが含まれているか確認
2. 含まれていない場合、人材キーワードの高重みに追加
3. 含まれている場合、人材スコアの閾値を下げる（例: 3 → 2）

### Q: 判定が不安定

**A**: スコアの閾値を調整します：

- 案件スコアの閾値を上げる（例: 2 → 3）→ より確実な案件メールのみ処理
- 人材スコアの閾値を下げる（例: 3 → 2）→ より積極的に人材メールを除外

## 関連ファイル

- `torch-batch.js` - メインのバッチ処理ファイル（キーワード定義とフィルタリングロジック）
- `関数一覧.md` - 関数の詳細説明

## 更新履歴

- 2025-01-XX: 初版作成（サンプルデータ分析に基づくキーワード調整）
