# batch 関数一覧

このドキュメントは、batch ディレクトリ内の関数とその実行方法を説明します。

## ファイル構成

- **torch-batch.js** - メインのバッチ処理ファイル（実際に使用されている）
- **main.js** - 使用されていない（空ファイル）
- **db.js** - 使用されていない（空ファイル）
- **email-processor.js** - 使用されていない（空ファイル）

## 関数一覧

### 1. `processEmailsTrigger()`

**概要**: メール自動処理のメイン関数。5 分ごとにトリガーで実行されることを想定。

**処理内容**:

- 前日以降の未読メールを検索（`eigyo@luxy-inc.com`宛）
- **事前フィルタリング**: 案件関連キーワードを含むメールのみを抽出（`shouldProcessMail()`）
- **重複チェック**: 既に処理済みのメールをスキップ（`isAlreadyProcessed()`）
- **レート制限対策**: 1 回の実行で最大 10 件まで処理（`MAX_PROCESS_PER_RUN`）
- **API 呼び出し間隔制御**: 各 API 呼び出しの間に 500ms 待機
- 各メールに対して`processSingleMail()`を実行
- 処理結果に応じてメールを既読にする
- 成功/スキップ/エラー件数をログ出力
- **レート制限検出**: API レート制限エラーを検出した場合は処理を中断

**実行方法**:

- Google Apps Script のトリガー設定で 5 分ごとに自動実行
- 手動実行: GAS エディタで関数を選択して実行

**戻り値**: なし（ログ出力のみ）

**必要な環境変数**:

- `GEMINI_API_KEY` - Gemini API のキー
- `TORCH_API_URL` - Torch API の URL
- `TORCH_API_KEY` - Torch API の認証キー

---

### 2. `processSingleMail(message)`

**概要**: 個別のメールを処理し、案件情報を抽出して API に送信する。

**処理内容**:

1. メール本文を取得・整形
2. Gemini API で案件情報を抽出（`createJobExtractionPrompt()`でプロンプト生成）
3. JSON をパースして案件データを取得
4. 案件情報が見つからない場合はスキップ
5. Torch API に案件情報を送信（`sendToTorchAPI()`）

**パラメータ**:

- `message` - Gmail の Message オブジェクト

**戻り値**:

- `'success'` - 案件情報を正常に保存
- `'skip'` - 案件情報が見つからない、または本文が空
- `'error'` - 処理中にエラーが発生

**実行方法**:

- `processEmailsTrigger()`から自動的に呼び出される
- テスト用に手動実行する場合:

```javascript
const message = GmailApp.getMessageById("メールID");
processSingleMail(message);
```

---

### 3. `createJobExtractionPrompt(mailBody, subject)`

**概要**: Gemini API に送信する案件情報抽出用のプロンプトを生成する。

**処理内容**:

- メール件名と本文を含むプロンプトを作成
- 案件情報の抽出ルールを定義
- JSON 形式での出力を指示

**パラメータ**:

- `mailBody` - メール本文（文字列）
- `subject` - メール件名（文字列）

**戻り値**: プロンプト文字列

**実行方法**: `processSingleMail()`から自動的に呼び出される

**抽出される情報**:

- `title` - 案件タイトル
- `company` - 企業名
- `grade` - ポジション（チームリーダー、テックリード、PMO、PM、SE）
- `location` - 勤務地
- `unitPrice` - 単価（万円単位）
- `summary` - 案件概要（200 字以内）
- `description` - 詳細説明
- `skills` - 必要なスキルの配列

---

### 4. `callGeminiAPI(prompt)`

**概要**: Gemini API を呼び出して案件情報を抽出する。

**処理内容**:

1. Gemini API（`gemini-2.0-flash-lite`モデル）にリクエスト送信
2. JSON 形式でレスポンスを取得
3. エラーハンドリング（レート制限エラーの検出を含む）

**パラメータ**:

- `prompt` - Gemini API に送信するプロンプト文字列

**戻り値**:

- 成功時: `{ success: true, data: string, isRateLimited: false }`
- 失敗時: `{ success: false, data: null, isRateLimited: boolean }`
  - `isRateLimited`: レート制限エラーの場合`true`

**実行方法**: `processSingleMail()`から自動的に呼び出される

**使用する環境変数**:

- `GEMINI_API_KEY` - Gemini API のキー

---

### 6. `shouldProcessMail(message)`

**概要**: メールが処理対象かどうかを判定（事前フィルタリング）。

**処理内容**:

- メール件名と本文から案件関連キーワードを検索
- 除外キーワード（会議、挨拶など）が含まれている場合はスキップ
- ただし、除外キーワードと案件キーワードの両方が含まれている場合は処理対象

**パラメータ**:

- `message` - Gmail の Message オブジェクト

**戻り値**: `boolean` - 処理対象の場合`true`

**実行方法**: `processEmailsTrigger()`から自動的に呼び出される

**キーワード**:

- **案件キーワード**: 案件、求人、プロジェクト、募集、エンジニア、開発、システム、単価、万円、業務委託、SIer、SES、PM、SE、PG、フロントエンド、バックエンド、インフラ、AWS、React、Vue、Java、Python、TypeScript、Go、PHP、Ruby、Node.js など
- **除外キーワード**: 会議、ミーティング、打ち合わせ、調整、お疲れ様、ご挨拶、お礼、ありがとう、失礼、お世話、ご連絡、ご報告 など

---

### 7. `isAlreadyProcessed(messageId)`

**概要**: メール ID が既に処理済みかどうかをチェック。

**処理内容**:

- ScriptCache を使用して処理済みメール ID を保存
- 6 時間キャッシュ（GAS の制限により最大 6 時間）

**パラメータ**:

- `messageId` - メール ID（文字列）

**戻り値**: `boolean` - 処理済みの場合`true`

**実行方法**: `processEmailsTrigger()`から自動的に呼び出される

---

### 8. `markAsProcessed(messageId)`

**概要**: メール ID を処理済みとしてマーク。

**処理内容**:

- ScriptCache に処理済みフラグを保存（6 時間）

**パラメータ**:

- `messageId` - メール ID（文字列）

**戻り値**: なし

**実行方法**: `processEmailsTrigger()`から自動的に呼び出される

---

### 5. `sendToTorchAPI(jobData)`

**概要**: 抽出した案件情報を Torch API に送信する。

**処理内容**:

1. Torch API の`/api/jobs/import`エンドポイントに POST リクエスト送信
2. API キー認証を使用
3. レスポンスをパースして結果を返す

**パラメータ**:

- `jobData` - 送信する案件情報オブジェクト
  ```javascript
  {
    title: string,
    company: string,
    grade: string,
    location: string,
    unitPrice: number | null,
    summary: string,
    description: string,
    originalTitle: string,
    originalBody: string,
    senderEmail: string,
    receivedAt: string,
    skills: string[]
  }
  ```

**戻り値**:

- 成功時: `{ success: true, jobId: string }`
- 失敗時: `{ success: false, error: string }`

**実行方法**: `processSingleMail()`から自動的に呼び出される

**使用する環境変数**:

- `TORCH_API_URL` - Torch API の URL
- `TORCH_API_KEY` - Torch API の認証キー

---

## 実行フロー

```
1. トリガー実行（5分ごと）
   ↓
2. processEmailsTrigger()
   - 未読メールを検索（最大100件）
   ↓
3. 事前フィルタリング（shouldProcessMail()）
   - 案件関連キーワードを含むメールのみを抽出
   - 除外キーワードで明らかに案件ではないメールをスキップ
   ↓
4. 重複チェック（isAlreadyProcessed()）
   - 既に処理済みのメールをスキップ
   ↓
5. レート制限対策
   - 最大10件まで処理（MAX_PROCESS_PER_RUN）
   - API呼び出し間に500ms待機
   ↓
6. 各メールに対して processSingleMail()
   - メール本文を取得
   ↓
7. createJobExtractionPrompt()
   - プロンプトを生成
   ↓
8. callGeminiAPI()
   - AIで案件情報を抽出
   - レート制限エラーを検出
   ↓
9. sendToTorchAPI()
   - Torch APIに案件情報を送信
   ↓
10. markAsProcessed() + メールを既読にする
```

## 設定

### スクリプトプロパティ（Google Apps Script）

以下の環境変数を設定する必要があります：

1. **GEMINI_API_KEY** - Gemini API のキー
2. **TORCH_API_URL** - Torch API の URL（例: `https://your-domain.com`）
3. **TORCH_API_KEY** - Torch API の認証キー

### 設定方法

1. Google Apps Script エディタを開く
2. 「プロジェクトの設定」→「スクリプト プロパティ」を開く
3. 上記の 3 つのプロパティを追加

### トリガー設定

1. Google Apps Script エディタで「トリガー」を開く
2. 「トリガーを追加」をクリック
3. 以下の設定:
   - 実行する関数: `processEmailsTrigger`
   - イベントのソース: 時間主導型
   - 時間ベースのトリガー: 分ベースのタイマー
   - 分の間隔: 5 分おき

## テスト方法

### 手動テスト

1. **特定のメールを処理**:

```javascript
// GASエディタで実行
const threads = GmailApp.search("to:eigyo@luxy-inc.com is:unread", 0, 1);
if (threads.length > 0) {
  const message = threads[0].getMessages()[0];
  const result = processSingleMail(message);
  console.log("結果:", result);
}
```

2. **ログ確認**:
   - GAS エディタの「実行ログ」で処理結果を確認
   - エラーが発生した場合はスタックトレースを確認

## API リミット対策

以下の最適化により、Gemini API のリミットを大幅に削減しています：

1. **事前フィルタリング**: キーワードベースで案件メールのみを抽出

   - 案件関連キーワードを含むメールのみを処理
   - 会議調整、挨拶メールなどは事前にスキップ
   - **効果**: API 呼び出しを約 50-70% 削減（推定）

2. **レート制限**: 1 回の実行で最大 10 件まで処理

   - `MAX_PROCESS_PER_RUN = 10` で制限
   - 5 分ごとの実行 × 10 件 = 1 時間あたり最大 120 件
   - **効果**: 1 日の API 呼び出しを約 2,880 回に制限

3. **重複チェック**: 同じメールを 2 回処理しない

   - ScriptCache で処理済みメール ID を保存
   - **効果**: 誤って同じメールを処理することを防止

4. **API 呼び出し間隔**: 各リクエスト間に 500ms 待機

   - `API_CALL_DELAY_MS = 500`
   - **効果**: API サーバーへの負荷を軽減

5. **レート制限検出**: API レート制限エラーを検出して処理を中断
   - HTTP 429 エラーや quota エラーを検出
   - レート制限に達した場合は処理を中断して次回に回す

## 設定可能なパラメータ

以下の定数を変更することで動作を調整できます：

```javascript
var MAX_PROCESS_PER_RUN = 10; // 1回の実行で処理する最大メール数
var API_CALL_DELAY_MS = 500; // API呼び出し間の待機時間（ミリ秒）
var MAX_THREADS_TORCH = 100; // 検索する最大メール数
```

## 注意事項

- 1 回の実行で最大 10 件まで処理（API リミット対策）
- 処理時間は GAS の制限（6 分）以内に収める必要がある
- エラーが発生しても他のメールの処理は継続される
- 案件情報が見つからないメールは自動的にスキップされる
- API レート制限に達した場合は処理を中断し、次回の実行で再試行
- 事前フィルタリングにより、一部の案件メールがスキップされる可能性がある（キーワードが含まれていない場合）
