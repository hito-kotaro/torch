<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>AIメール情報管理システム</title>
  <style>
    :root {
      --primary-bg: #f8f9fa;
      --secondary-bg: #ffffff;
      --border-color: #dee2e6;
      --header-bg: #343a40;
      --header-text: #ffffff;
      --table-header-bg: #e9ecef;
      --accent-color: #007bff;
      --text-color: #212529;
      --link-color: #0056b3;
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    body {
      font-family: var(--font-family);
      background-color: var(--primary-bg);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
    }
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .left-pane {
      width: 100%;
      min-width: 500px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
      transition: width 0.3s ease-in-out;
      box-sizing: border-box;
    }
    .left-pane.shrunk {
      width: 60%;
    }
    .right-pane {
      width: 0;
      padding: 0;
      background-color: var(--secondary-bg);
      position: relative;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
      overflow: hidden;
      box-sizing: border-box;
    }
    .right-pane:not(.hidden) {
      width: 40%;
      padding: 15px;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }
    .preview-header-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    #open-gmail-btn {
        background-color: #c82333;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }
    .preview-info {
      padding: 10px;
      background-color: #f1f3f5;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 0.9em;
      line-height: 1.6;
      flex-shrink: 0;
    }
    #preview-subject:hover {
      text-decoration: underline;
      background-color: #e9ecef;
    }

    .preview-info strong {
      margin-right: 5px;
    }
    .preview-info span {
      margin-right: 15px;
    }
    #mail-preview {
      width: 100%;
      height: 100%;
      border: 1px solid var(--border-color);
      flex-grow: 1;
    }
    .close-btn {
      font-size: 24px;
      cursor: pointer;
      font-weight: bold;
      border: none;
      background: none;
      padding: 0 10px;
    }
    .search-area, .matching-area, .import-area {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
     .results-area {
      background-color: var(--secondary-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      flex: 1;
      overflow: auto;
    }
    .search-area h2, .results-area h2, .matching-area h2, .import-area h2 {
      margin-top: 0;
      font-size: 1.2em;
    }
    .form-group {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px 10px;
      align-items: center;
    }
    .form-group label {
      font-weight: bold;
      margin-right: 5px;
    }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .skill-category {
      border: 1px solid var(--border-color);
      border-radius: 4px;
      flex: 1 1 45%;
    }
    .skill-category summary {
      font-weight: bold;
      padding: 8px;
      cursor: pointer;
      background-color: #f8f9fa;
    }
    .skill-tags-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      padding: 10px;
    }
    .skill-tag-item label {
      cursor: pointer;
    }
    
    .data-table {
      min-width: 1800px;
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .data-table th, .data-table td {
      border: 1px solid var(--border-color);
      padding: 8px;
      text-align: left;
      font-size: 0.9em;
      vertical-align: top;
      word-wrap: break-word;
    }
    .data-table th {
      background-color: var(--table-header-bg);
      color: var(--text-color);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .data-table a {
      color: var(--link-color);
      text-decoration: underline;
      cursor: pointer;
    }
    .data-table tbody tr {
        cursor: pointer;
    }
    .data-table tbody tr:hover {
        background-color: #f0f0f0;
    }

    /* ★★★ 修正: テーブル列の幅 ★★★ */
    .col-id { width: 3em; }
    .col-received-date { width: 5em; white-space: pre-line; }
    .col-company { width: 8em; }
    .col-name { width: 4em; }
    .col-project-name { width: 8em; }
    .col-gender { width: 4em; }
    .col-age { width: 4em; }
    .col-price { width: 4em; }
    .col-station, .col-location { width: 8em; }
    .col-affiliation { width: 6em; }
    .col-skill-tags { width: 10em; }
    .col-period { width: 6em; }
    .col-nationality { width: 5em; }
    .col-desired-position, .col-required-position { width: 10em; }
    .col-skill-summary, .col-wish-summary, .col-other-summary, .col-skill-req-summary {
        width: 15em;
    }

    .id-link { cursor: pointer; color: var(--accent-color); font-weight: bold; }
    .hidden { display: none; }
    #loader {
      text-align: center;
      padding: 20px;
      font-weight: bold;
    }
    #motivational-quote {
        margin-top: 15px;
        font-style: italic;
        color: #343a40;
        font-size: 1.3em;
    }
    .header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        background-color: var(--header-bg);
        color: var(--header-text);
        flex-shrink: 0;
    }
    .header-bar-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }
    .header-bar h1 {
        margin: 0;
        font-size: 1.5em;
    }
    .header-buttons button {
        margin-left: 10px;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: white;
    }
    #refresh-cache-btn {
        background-color: #28a745;
    }
    #delete-data-btn {
        background-color: #dc3545;
    }
    
    #matching-text { width: 100%; height: 100px; }
    #matching-results ul { list-style-type: none; padding-left: 0; }
    #matching-results li { background-color: #e9ecef; padding: 10px; margin-bottom: 5px; border-radius: 4px; }
    #matching-results li strong { color: var(--accent-color); }
    #matching-results li:hover { background-color: #dcdcdc; cursor: pointer; }
    
    .header-tab-nav {
        display: flex;
        height: 100%;
    }
    .header-tab-link {
        background-color: transparent;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 20px;
        transition: background-color 0.3s;
        font-size: 1em;
        color: var(--header-text);
        border-bottom: 3px solid transparent;
    }
    .header-tab-link:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .header-tab-link.active {
        background-color: rgba(255,255,255,0.2);
        border-bottom: 3px solid var(--accent-color);
    }

    .tab-content {
        display: none;
        flex-direction: column;
        flex: 1;
        overflow: auto;
    }
    
    .matching-buttons button, #import-btn {
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        color: white;
        border: none;
    }
    #matching-btn { background-color: var(--accent-color); }
    #cancel-matching-btn { background-color: #6c757d; }
    #import-btn { background-color: #28a745; }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #reset-search-btn {
        padding: 6px 12px;
        font-size: 0.9em;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    #reset-search-btn:hover {
        background-color: #5a6268;
    }
    
    #import-urls {
      width: 100%;
      height: 120px;
      font-family: monospace;
    }
    #import-results {
      margin-top: 15px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    #skill-tags-toggle {
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 5px 0;
    }
    #skill-tags-container {
        overflow: hidden;
        transition: max-height 0.4s ease-in-out, margin-top 0.4s ease-in-out;
        max-height: 1500px;
        margin-top: 10px;
        width: 100%;
    }
    #skill-tags-container.collapsed {
        max-height: 0;
        margin-top: 0;
    }
    
    .filter-top-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 10px;
    }
    .filter-col-left {
      flex: 2;
      min-width: 250px;
    }
    .filter-col-right {
      flex: 3;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px 20px;
    }
    .filter-group-inline .form-group {
      margin-bottom: 0;
    }
    input.small-input {
      width: 60px;
    }

  </style>
</head>
<body>

  <div class="header-bar">
    <div class="header-bar-left">
        <h1>AIメール情報管理システム</h1>
        <div class="header-tab-nav">
          <button id="defaultOpen" class="header-tab-link active" onclick="openTab(event, 'search-tab')">検索</button>
          <button class="header-tab-link" onclick="openTab(event, 'matching-tab')">AIマッチング</button>
          <button class="header-tab-link" onclick="openTab(event, 'import-tab')">インポート</button>
          <button class="header-tab-link" onclick="openTab(event, 'url-search-tab')">URL横断検索</button>
        </div>
    </div>
    <div class="header-buttons">
      <button id="refresh-cache-btn">キャッシュを更新</button>
      <button id="delete-data-btn">古いデータを削除</button>
    </div>
  </div>

  <div class="container">
    <div class="left-pane" id="left-pane">

      <div id="search-tab" class="tab-content">
        <div class="search-area">
          <div class="filter-header">
            <h2>検索フィルター</h2>
            <button type="button" id="reset-search-btn">検索条件をリセット</button>
          </div>
          <form id="search-form">
            <div class="form-group">
              <label>DB選択:</label>
              <input type="radio" id="db_jinzai" name="db_type" value="jinzai" checked>
              <label for="db_jinzai">人材DB</label>
              <input type="radio" id="db_anken" name="db_type" value="anken">
              <label for="db_anken">案件DB</label>
            </div>
            <div id="jinzai-filters">
                <div class="form-group">
                    <input type="text" id="free_word" placeholder="フリーワード検索 (全体)" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label for="age_min">年齢:</label>
                    <input type="number" id="age_min" placeholder="下限"> ~ <input type="number" id="age_max" placeholder="上限">
                    <label for="price_min_jinzai">単価(万):</label>
                    <input type="number" id="price_min_jinzai" placeholder="下限"> ~ <input type="number" id="price_max_jinzai" placeholder="上限">
                    <label for="work_style_jinzai">出社可否:</label>
                    <select id="work_style_jinzai">
                    <option value="">すべて</option>
                    <option value="出社">出社</option>
                    <option value="リモート">リモート</option>
                    <option value="併用">併用</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>所属種別:</label>
                    <input type="radio" id="affiliation_all" name="affiliation_type" value="all" checked>
                    <label for="affiliation_all">すべて</label>
                    <input type="radio" id="affiliation_employee" name="affiliation_type" value="employee">
                    <label for="affiliation_employee">社員</label>
                    <input type="radio" id="affiliation_other" name="affiliation_type" value="other">
                    <label for="affiliation_other">その他</label>

                    <label style="margin-left: 20px;">国籍:</label>
                    <input type="radio" id="nationality_all" name="nationality_type" value="all" checked>
                    <label for="nationality_all">すべて</label>
                    <input type="radio" id="nationality_jp" name="nationality_type" value="日本籍">
                    <label for="nationality_jp">日本籍</label>
                    <input type="radio" id="nationality_foreign" name="nationality_type" value="外国籍">
                    <label for="nationality_foreign">外国籍</label>
                </div>
            </div>
            <div id="anken-filters" class="hidden">
                <div class="form-group">
                    <input type="text" id="free_word_anken" placeholder="フリーワード検索 (全体)" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label for="price_min_anken">単価(万):</label>
                    <input type="number" id="price_min_anken" placeholder="下限"> ~ <input type="number" id="price_max_anken" placeholder="上限">
                    <label for="work_style_anken">出社可否:</label>
                    <select id="work_style_anken">
                    <option value="">すべて</option>
                    <option value="出社">出社</option>
                    <option value="リモート">リモート</option>
                    <option value="併用">併用</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="flex-direction: column; align-items: flex-start; margin-bottom: 0;">
              <label id="skill-tags-toggle">
                スキルタグ (AND検索) <span id="skill-tags-toggle-icon">▶</span>
              </label>
              <div id="skill-tags-container" class="collapsed"></div>
            </div>
          </form>
        </div>
        <div class="results-area">
          <div class="results-header">
            <h2>検索結果 <span id="results-count"></span></h2>
            <div id="pagination-controls"></div>
          </div>
          <div id="loader" class="hidden">
            検索中...
            <p id="motivational-quote"></p>
          </div>
          <div id="results-table-container"></div>
        </div>
      </div>

      <div id="matching-tab" class="tab-content">
        <div class="matching-area">
          <h2>AIマッチング機能</h2>
          <div class="form-group">
            <label>マッチング元:</label>
            <input type="radio" id="match_type_jinzai" name="match_type" value="jinzai" checked>
            <label for="match_type_jinzai">人材情報から案件を探す</label>
            <input type="radio" id="match_type_anken" name="match_type" value="anken">
            <label for="match_type_anken">案件情報から人材を探す</label>
          </div>
          <div class="form-group">
            <label for="matching-id" id="matching-id-label">IDで人材を指定:</label>
            <input type="text" id="matching-id" placeholder="人材DBのIDを入力">
            <span style="margin: 0 10px;">または</span>
          </div>
          <div class="form-group">
            <textarea id="matching-text" placeholder="ここに人材情報または案件情報のテキストを貼り付け"></textarea>
          </div>
          <div class="form-group">
             <label for="max-matching-results">最大取得件数:</label>
             <input type="number" id="max-matching-results" value="20" min="1" max="50" style="width: 60px;">
             <label for="matching-prompt" style="margin-left: 20px;">追加条件:</label>
             <input type="text" id="matching-prompt" placeholder="" style="flex-grow: 1;">
          </div>
          <div class="matching-buttons">
            <button id="matching-btn">マッチング開始</button>
            <button id="cancel-matching-btn" class="hidden">キャンセル</button>
          </div>
          <div id="matching-results"></div>
        </div>
      </div>
      
      <div id="import-tab" class="tab-content" style="display: block; flex: 1;">
        <div class="import-area">
          <h2>スプレッドシートからインポート</h2>
          <p>GoogleスプレッドシートのURLを改行で区切って入力してください。<br>
          AIがシートの内容（人材 or 案件）を自動で判断し、適切なDBにインポートします。<br>
          <strong>注意:</strong> 処理を実行するアカウントが、対象シートの「閲覧者」以上の権限を持っている必要があります。</p>
          <div class="form-group">
            <label for="import-urls">スプレッドシートURL:</label>
            <textarea id="import-urls" placeholder="https://docs.google.com/spreadsheets/d/xxxxxxxxxx/edit&#10;https://docs.google.com/spreadsheets/d/yyyyyyyyyy/edit"></textarea>
          </div>
          <button id="import-btn">インポート実行</button>
          <div id="import-loader" class="hidden" style="margin-top: 15px;">
             インポート処理を実行中... AIによるデータ変換のため、時間がかかる場合があります。
          </div>
          <div id="import-results"></div>
        </div>
      </div>

      <div id="url-search-tab" class="tab-content">
        <div class="import-area">
          <h2>URL横断検索</h2>
          <p>Googleドキュメント、スプレッドシート、または公開WebページのURLを改行で区切って入力し、<br>
          指定したキーワードが本文に含まれるURLを検索します。</p>
          <div class="form-group">
            <label for="search-urls">検索対象URL:</label>
            <textarea id="search-urls" placeholder="https://docs.google.com/document/d/xxxxxxxxxx/edit&#10;https://example.com/page.html" style="height: 150px; width: 100%;"></textarea>
          </div>
          <div class="form-group">
            <label for="search-keyword">キーワード:</label>
            <input type="text" id="search-keyword" placeholder="検索したいキーワードを入力" style="width: 300px;">
          </div>
          <button id="url-search-btn" class="matching-buttons" style="background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">検索実行</button>
          <div id="url-search-loader" class="hidden" style="margin-top: 15px;">
             検索中...
          </div>
          <div id="url-search-results" style="margin-top: 15px;"></div>
        </div>
      </div>


    </div>
    <div class="right-pane hidden" id="preview-pane">
        <div class="preview-header">
            <div class="preview-header-left">
                <h3>メールプレビュー</h3>
                <button id="open-gmail-btn" class="hidden">Gmailで開く</button>
            </div>
            <button class="close-btn" id="close-preview-btn">×</button>
        </div>
        <div id="preview-info" class="preview-info"></div>
        <iframe id="mail-preview"></iframe>
    </div>
  </div>

<script>
  // ===============================================================
  // グローバル変数・定数
  // ===============================================================
  const SKILL_CATEGORIES = {
    "🧑‍💻 プログラミング言語": ["ABAP", "ActionScript", "Apex", "Bash", "C", "C#", "C++", "C Shell", "COBOL", "CSS", "Dart", "Go (Golang)", "HTML", "Java", "JavaScript", "Kotlin", "Lua", "MATLAB", "Objective-C", "Pascal", "Perl", "PHP", "Pro*C", "Python", "R", "Ruby", "Rust", "Sass", "Scala", "Shell", "Shell Script", "SQL", "Swift", "TypeScript", "VBA", "VBScript", "Visual Basic", "XML", "YAML"],
    "🏗️ フレームワーク": [".NET", "Angular", "ASP.NET", "Backbone.js", "Blazor", "Bootstrap", "CakePHP", "Cocos2d-x", "CodeIgniter", "Django", "Electron", "Entity Framework", "Express.js", "FastAPI", "Flask", "Flutter", "FuelPHP", "Gin", "Hibernate", "jQuery", "Laravel", "MyBatis", "NestJS", "Next.js", "Node.js", "Nuxt.js", "Play Framework", "React", "React Native", "Ruby on Rails", "Spring", "Spring Boot", "Struts", "SwiftUI", "Symfony", "Tailwind CSS", "TERASOLUNA", "Thymeleaf", "Unreal Engine", "Unity", "Vue.js", "Vuetify", "WPF", "Yii", "Zend Framework"],
    "📦 パッケージ製品": ["BizRobo!", "Blue Prism", "Business Objects", "Dr.Sum", "Drupal", "Dynamics 365", "EC-CUBE", "HULFT", "Intra-mart", "Marketing Cloud", "Marketo", "Movable Type", "Oracle EBS", "Pardot", "S/4HANA", "Salesforce", "SAP", "ServiceNow", "Shopify", "Systemwalker", "UiPath", "WinActor", "WordPress"],
    "🛠️ ツール": ["Active Directory", "Anaconda", "Android Studio", "Ansible", "Apache", "Atom", "AutoCAD", "ChatGPT", "Confluence", "DataDog", "DataSpider", "Databricks", "DB2", "dbt", "DBeaver", "Docker", "Eclipse", "Elasticsearch", "F5", "FortiGate", "GAS (Google Apps Script)", "Git", "GitHub", "GitLab", "Gradle", "GraphQL", "IIS", "Informatica", "IntelliJ", "JBoss", "Jenkins", "Jira", "JMeter", "Jupyter", "Keras", "Kibana", "Kubernetes", "LoadBalancer", "MariaDB", "Maven", "Metabase", "MongoDB", "MySQL", "Nagios", "NetBeans", "New Relic", "Nginx", "NumPy", "OpenAPI", "Oracle Database", "Palo Alto", "Pandas", "phpMyAdmin", "Podman", "PostgreSQL", "Postman", "PowerShell", "PuTTY", "PyTorch", "Qt", "Redash", "Redis", "Scikit-learn", "Selenium", "Snowflake", "Splunk", "SQL Server", "SQL Server Management Studio (SSMS)", "SQLite", "Subversion (SVN)", "Swagger", "TensorFlow", "Tera Term", "Terraform", "Tivoli", "Tomcat", "Visual Studio", "Visual Studio Code (VSCode)", "WebLogic", "WebSphere", "WinSCP", "Wireshark", "Zabbix"],
    "☁️ クラウドプラットフォーム": ["AlibabaCloud", "AWS (Amazon Web Services)", "Azure", "BigQuery", "CosmosDB", "Firebase", "Firestore", "GCP (Google Cloud Platform)", "Heroku", "OCI (Oracle Cloud Infrastructure)", "Vercel"]
  };
  const JINZAI_HEADERS = ["ID", "受信日時", "社名", "氏名", "性別", "国籍", "年齢", "単価", "最寄駅", "所属", "スキルタグ", "スキルサマリー", "希望サマリー", "希望ポジション", "その他サマリー"];
  const ANKEN_HEADERS = ["ID", "受信日時", "社名", "案件名", "場所", "スキルタグ", "スキル要件サマリー", "求めるポジション", "単価", "期間", "その他サマリー"];
  let isMatchingCancelled = false;
  let currentPage = 1;
  const ITEMS_PER_PAGE = 50;
  let searchRetryCount = 0;
  
  const SALES_QUOTES = [
    "現状維持では後退するばかりである。", "成功とは99％の失敗である。", "失敗？これはうまくいかないということを確認した成功だよ。", "行動だけが、後悔を生まない唯一の選択肢だ。",
    "大きなことを成し遂げるための唯一の方法は、自分の仕事を愛することだ。", "困難の中に、機会がある。", "千里の道も一歩から。", "考えを行動に移さない限り、それは価値のないものだ。",
    "最も大きなリスクは、リスクを取らないことだ。", "未来を予測する最善の方法は、それを発明することだ。", "凡事徹底。当たり前のことを非凡な情熱を持って行う。",
    "挑戦すれば、成功か学びのどちらかしかない。", "今日の成果は過去の努力の結果であり、未来はこれからの努力で決まる。", "人は、自分が考えた通りの人間になる。",
    "情熱なしに偉大なことは成し遂げられない。", "石の上にも三年。継続は力なり。", "できると信じるか、できないと信じるか。どちらも正しい。",
    "問題なのは、問題があることではない。問題意識がないことだ。", "準備を怠ることは、失敗の準備をすることだ。", "言い訳は、敗者のための鎮痛剤にすぎない。",
    "行動を伴わないビジョンは、ただの夢だ。", "自分を信じろ。それが成功への第一歩だ。", "目標を達成する秘訣は、行動を始めることだ。",
    "小さな一歩の積み重ねが、とんでもない所へ行くただ一つの道だ。", "困難の向こうに、成長がある。", "熱意は、スキルに勝る。",
    "お客様の成功が、我々の成功だ。", "聞く力は、最強の営業スキルだ。", "約束は、何があっても守れ。それが信頼だ。", "今日のタネまきが、明日の収穫になる。",
    "ライバルは、市場にではなく、自分の中にいる。", "変化を恐れるな。変化こそがチャンスだ。", "スピードは、誠意の表れだ。",
    "できない理由を100個探すより、できる方法を1つ見つけろ。", "プロフェッショナルとは、期待を超え続ける人間のことだ。", "感謝の言葉は、最強の人間関係構築術だ。",
    "自分の仕事に、物語を語らせろ。", "逆境は、自分の真価を試す試金石だ。", "決断の速さが、ビジネスの速さだ。", "学び続ける者だけが、勝ち続ける。",
    "誠実さは、どんなテクニックにも勝る。", "「なぜ」を5回繰り返せ。本質が見えてくる。", "情熱は、不可能を可能にする。",
    "最高のサービスは、最高の笑顔から生まれる。", "諦めたら、そこで試合終了だよ。", "失敗から学べば、それはもう失敗ではない。",
    "一人の力は小さい。だが、チームの力は無限大だ。", "常に半歩先を読め。それが優位性を生む。", "お客様の想像を超えた時、感動が生まれる。",
    "自分の限界を決めるのは、自分だけだ。", "行動の量が、自信の量を決める。", "苦しい時こそ、リーダーシップが問われる。", "基本を疎かにする者に、応用はない。",
    "目標を紙に書けば、それは計画になる。", "情熱は伝染する。まず自分が火付け役になれ。", "No.1を目指さない者に、No.2の資格もない。",
    "「ありがとう」を、一日何回言っているか？", "問題は、避けるものではなく、解決するものだ。", "自分の仕事に、愛はあるか？",
    "成功者は、例外なく聞き上手だ。", "準備にかけた時間が、商談の時間を短縮する。", "言い訳のうまい人間に、仕事のできる人間はいない。",
    "リスクを取らないことが、最大のリスク。", "迷ったら、お客様にとってプラスになる方を選べ。", "「できません」ではなく、「どうすればできるか」を考えろ。",
    "ライバルに勝つことより、お客様に勝たせることを考えろ。", "クレームは、宝の山だ。", "感動は、細部に宿る。",
    "自分の成長が、会社の成長に繋がる。", "目標を共有すれば、それはチームの力になる。", "常に明るく、元気よく、前向きに。",
    "即レス、即対応。信頼はそこから生まれる。", "PDCAのC（チェック）が一番大事だ。", "困難な道こそ、自分を成長させる近道だ。",
    "「もし」を語るな。「どう」を語れ。", "自分の言葉に責任を持て。", "お客様のビジネスを、自分事として考えろ。", "挨拶は、人間関係の基本のキ。",
    "メモを取る習慣が、記憶の限界を超える。", "時間だけは、誰にでも平等だ。どう使うかで差がつく。", "「知っている」と「できる」は違う。",
    "ロールプレイングは、本番のための最高の練習だ。", "トップセールスの真似をしろ。まずはそこからだ。", "笑顔は、コストゼロの最強の武器だ。",
    "「なぜなら」で語る癖をつけろ。説得力が変わる。", "目的意識が、行動の質を高める。", "自分の強みを知り、それを磨き続けろ。",
    "弱音を吐く前に、限界までやれ。", "「運」は、準備が整った者に訪れる。", "お客様の成功事例を語れ。それが最高の営業ツールだ。",
    "断られることを、楽しめ。", "常に平常心。それがプロの証だ。", "目標は、数値化してこそ意味がある。", "仲間を助けろ。それが回り回って自分を助ける。",
    "「すみません」より「ありがとう」を。", "自分の仕事の価値を、自分で信じろ。", "行動すれば、次の行動が見えてくる。", "成功の反対は、何もしないことだ。"
  ];


  // ===============================================================
  // イベントリスナー
  // ===============================================================
  window.onload = function() {
    initSkillTags();
    setupEventListeners();
    document.getElementById("defaultOpen").click();
    triggerSearch(1);
  };

  function setupEventListeners() {
    document.getElementById('search-form').addEventListener('input', debounce(function() { triggerSearch(1); }, 500));
    document.querySelectorAll('input[name="db_type"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        toggleFilters();
        triggerSearch(1);
      });
    });
    document.getElementById('close-preview-btn').addEventListener('click', function() {
      document.getElementById('preview-pane').classList.add('hidden');
      document.getElementById('left-pane').classList.remove('shrunk');
      document.getElementById('open-gmail-btn').classList.add('hidden');
    });
    document.getElementById('refresh-cache-btn').addEventListener('click', handleRefreshCache);
    document.getElementById('delete-data-btn').addEventListener('click', handleDeleteOldData);
    document.getElementById('matching-btn').addEventListener('click', handleMatching);
    document.getElementById('cancel-matching-btn').addEventListener('click', handleCancelMatching);
    document.querySelectorAll('input[name="match_type"]').forEach(function(radio) {
      radio.addEventListener('change', updateMatchingPlaceholder);
    });
    
    document.getElementById('reset-search-btn').addEventListener('click', function(event) {
        event.stopPropagation();
        handleResetSearch();
    });
    
    updateMatchingPlaceholder();

    document.getElementById('skill-tags-toggle').addEventListener('click', function() {
        const container = document.getElementById('skill-tags-container');
        const icon = document.getElementById('skill-tags-toggle-icon');
        container.classList.toggle('collapsed');
        if (container.classList.contains('collapsed')) {
            icon.textContent = '▶';
        } else {
            icon.textContent = '▼';
        }
    });

    document.getElementById('import-btn').addEventListener('click', handleImport);
    document.getElementById('url-search-btn').addEventListener('click', handleUrlSearch);
  }


  // ===============================================================
  // 機能関数
  // ===============================================================

  function handleUrlSearch() {
    const urls = document.getElementById('search-urls').value;
    const keyword = document.getElementById('search-keyword').value;

    if (!urls.trim() || !keyword.trim()) {
      alert('検索対象のURLとキーワードの両方を入力してください。');
      return;
    }

    const loader = document.getElementById('url-search-loader');
    const resultsDiv = document.getElementById('url-search-results');
    const searchBtn = document.getElementById('url-search-btn');
    const sessionId = Date.now().toString(); // ユニークなセッションID

    let allMatchingUrls = [];
    let allErrors = [];
    let processedCount = 0;
    let totalUrls = 0;

    loader.classList.remove('hidden');
    searchBtn.disabled = true;
    resultsDiv.innerHTML = '';
    resultsDiv.innerHTML = '<p>検索を開始しています...</p>';

    // 検索初期化
    google.script.run
      .withSuccessHandler(function(response) {
        totalUrls = response.totalUrls;
        resultsDiv.innerHTML = `<p>全 ${totalUrls} 件のURLを検索します。</p><div id="url-search-progress"></div><div id="url-search-matches"></div><div id="url-search-errors"></div>`;
        processNextBatch(sessionId, 0);
      })
      .withFailureHandler(function(error) {
        loader.classList.add('hidden');
        searchBtn.disabled = false;
        resultsDiv.innerHTML = `<p style="color: red;">エラー: ${escapeHtml(error.message)}</p>`;
      })
      .initializeUrlSearch(urls, keyword, sessionId);

    function processNextBatch(currentSessionId, startIndex) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            allMatchingUrls = allMatchingUrls.concat(response.matchingUrls);
            allErrors = allErrors.concat(response.errors);
            processedCount += response.processedCount;

            updateSearchResultsDisplay(processedCount, totalUrls, allMatchingUrls, allErrors);

            if (response.nextStartIndex !== null) {
              // 次のバッチを処理
              processNextBatch(currentSessionId, response.nextStartIndex);
            } else {
              // 全てのバッチ処理が完了
              loader.classList.add('hidden');
              searchBtn.disabled = false;
              google.script.run.clearUrlSearchSession(currentSessionId);
              resultsDiv.innerHTML += '<p>検索が完了しました。</p>';
            }
          } else {
            // バッチ処理中にエラーが発生
            loader.classList.add('hidden');
            searchBtn.disabled = false;
            google.script.run.clearUrlSearchSession(currentSessionId);
            resultsDiv.innerHTML = `<p style="color: red;">エラー: ${escapeHtml(response.error)}</p>`;
          }
        })
        .withFailureHandler(function(error) {
          loader.classList.add('hidden');
          searchBtn.disabled = false;
          google.script.run.clearUrlSearchSession(currentSessionId);
          resultsDiv.innerHTML = `<p style="color: red;">エラー: ${escapeHtml(error.message)}</p>`;
        })
        .processUrlBatch(currentSessionId, startIndex);
    }

    function updateSearchResultsDisplay(currentProcessed, total, matches, errors) {
      const progressDiv = document.getElementById('url-search-progress');
      const matchesDiv = document.getElementById('url-search-matches');
      const errorsDiv = document.getElementById('url-search-errors');

      progressDiv.innerHTML = `<p>処理中: ${currentProcessed} / ${total} 件</p>`;

      let matchesHtml = '<h4>キーワードが見つかったURL (' + matches.length + '件)</h4>';
      if (matches.length > 0) {
        matchesHtml += '<ul>';
        matches.forEach(function(url) {
          matchesHtml += `<li><a href="${escapeHtml(url)}" target="_blank">${escapeHtml(url)}</a></li>`;
        });
        matchesHtml += '</ul>';
      } else {
        matchesHtml += '<p>キーワードに一致するURLはまだ見つかっていません。</p>';
      }
      matchesDiv.innerHTML = matchesHtml;

      let errorsHtml = '<h4 style="color: red;">エラーが発生したURL (' + errors.length + '件)</h4>';
      if (errors.length > 0) {
        errorsHtml += '<ul>';
        errors.forEach(function(error) {
          errorsHtml += `<li>${escapeHtml(error.url)} - <strong>${escapeHtml(error.message)}</strong></li>`;
        });
        errorsHtml += '</ul>';
      } else {
        errorsHtml += '<p>エラーは発生していません。</p>';
      }
      errorsDiv.innerHTML = errorsHtml;
    }
  }
  
  function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("header-tab-link");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "flex";
    evt.currentTarget.className += " active";
  }

  function initSkillTags() {
    const container = document.getElementById('skill-tags-container');
    container.innerHTML = ''; 

    for (const category in SKILL_CATEGORIES) {
        const details = document.createElement('details');
        details.className = 'skill-category';

        const summary = document.createElement('summary');
        summary.textContent = category;
        details.appendChild(summary);

        const grid = document.createElement('div');
        grid.className = 'skill-tags-grid';

        SKILL_CATEGORIES[category].forEach(function(skill) {
            const id = 'skill_' + skill.replace(/[^a-zA-Z0-9]/g, '');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'skill-tag-item';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = id;
            input.name = 'skill_tags';
            input.value = skill;

            const label = document.createElement('label');
            label.htmlFor = id;
            label.textContent = skill;

            itemDiv.appendChild(input);
            itemDiv.appendChild(label);
            grid.appendChild(itemDiv);
        });

        details.appendChild(grid);
        container.appendChild(details);
    }
  }
  
  function triggerSearch(page) {
    page = page || 1;
    currentPage = page;
    searchRetryCount = 0;
    
    if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
        setTimeout(function() { triggerSearch(page); }, 200);
        return;
    }
    showLoader(true);
    document.getElementById('results-table-container').innerHTML = '';
    document.getElementById('results-count').textContent = '';
    document.getElementById('pagination-controls').innerHTML = '';
    
    const params = getSearchParams();
    google.script.run
      .withSuccessHandler(displayResults)
      .withFailureHandler(handleError)
      .searchDatabase(params, currentPage, ITEMS_PER_PAGE);
  }

  function getSearchParams() {
    const dbType = document.querySelector('input[name="db_type"]:checked').value;
    const params = {
      db_type: dbType,
      free_word: document.getElementById('free_word').value,
      skill_tags: Array.from(document.querySelectorAll('input[name="skill_tags"]:checked')).map(function(el) { return el.value; }),
    };
    if (dbType === 'jinzai') {
        params.age_min = document.getElementById('age_min').value;
        params.age_max = document.getElementById('age_max').value;
        params.price_min = document.getElementById('price_min_jinzai').value;
        params.price_max = document.getElementById('price_max_jinzai').value;
        params.work_style = document.getElementById('work_style_jinzai').value;
        params.affiliation_type = document.querySelector('input[name="affiliation_type"]:checked').value;
        params.nationality_type = document.querySelector('input[name="nationality_type"]:checked').value;
    } else {
        params.free_word = document.getElementById('free_word_anken').value;
        params.price_min = document.getElementById('price_min_anken').value;
        params.price_max = document.getElementById('price_max_anken').value;
        params.work_style = document.getElementById('work_style_anken').value;
    }
    return params;
  }
  
  function toggleFilters() {
    const dbType = document.querySelector('input[name="db_type"]:checked').value;
    document.getElementById('jinzai-filters').classList.toggle('hidden', dbType !== 'jinzai');
    document.getElementById('anken-filters').classList.toggle('hidden', dbType === 'jinzai');
  }

  function displayResults(response) {
    try {
      if (response === null && searchRetryCount < 1) {
        searchRetryCount++;
        console.log("Response was null. Retrying search... (Attempt " + searchRetryCount + ")");
        setTimeout(function() {
            const params = getSearchParams();
            google.script.run
                .withSuccessHandler(displayResults)
                .withFailureHandler(handleError)
                .searchDatabase(params, currentPage, ITEMS_PER_PAGE);
        }, 2000);
        return;
      }
      
      showLoader(false);
      
      if (response === null || response === undefined) {
        handleError("サーバーから応答がありませんでした (null)。処理がタイムアウトしたか、サーバー側で予期せぬエラーが発生した可能性があります。");
        return;
      }

      if (response.error) {
        handleError("Backend error: " + response.error);
        return;
      }

      if (!Array.isArray(response.headers) || !Array.isArray(response.data)) {
        handleError("サーバーから不正な形式の応答がありました。");
        return;
      }
      
      const { headers, data, totalItems } = response;
      const dbType = document.querySelector('input[name="db_type"]:checked').value;
      const displayHeaders = dbType === 'jinzai' ? JINZAI_HEADERS : ANKEN_HEADERS;
      
      const colIndices = displayHeaders.map(function(h) {
        if (h === '単価') {
            const priceIndex = headers.indexOf('希望単価');
            return priceIndex !== -1 ? priceIndex : headers.indexOf('単価');
        }
        return headers.indexOf(h);
      });

      const mailIdIndex = headers.indexOf('メールID');
      const mailLinkIndex = headers.indexOf('メールリンク');
      const idIndex = headers.indexOf('ID');
      const companyIndex = headers.indexOf('社名');
      const nameIndex = headers.indexOf(dbType === 'jinzai' ? '氏名' : '案件名');

      const container = document.getElementById('results-table-container');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.className = 'data-table';
      
      const thead = table.createTHead();
      const headerRow = thead.insertRow();
      displayHeaders.forEach(function(headerText) {
        const th = document.createElement('th');
        th.className = 'col-' + sanitizeHeaderForClass(headerText);
        th.textContent = headerText;
        headerRow.appendChild(th);
      });

      const tbody = table.createTBody();
      if(data.length > 0) {
        data.forEach(function(row) {
          const tr = tbody.insertRow();
          tr.onclick = function() { showPreview(this); };
          
          const id = row[idIndex] || '';
          const company = row[companyIndex] || '';
          const name = row[nameIndex] || '';
          const mailId = row[mailIdIndex] || '';
          const mailLink = row[mailLinkIndex] || '';
          
          tr.dataset.mailId = mailId;
          tr.dataset.mailLink = mailLink;
          tr.dataset.id = id;
          tr.dataset.company = company;
          tr.dataset.name = name;

          colIndices.forEach(function(index, i) {
            const td = tr.insertCell();
            const header = displayHeaders[i];
            td.className = 'col-' + sanitizeHeaderForClass(header);
            
            let cellData = (index === -1) ? '' : (row[index] || '');

            if (header === '受信日時') {
              td.innerHTML = formatDateTime(cellData);
            } else if (header === '最寄駅' && cellData) {
              const a = document.createElement('a');
              a.href = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(cellData);
              a.target = '_blank';
              a.textContent = cellData;
              td.appendChild(a);
            } else {
              td.textContent = cellData;
            }
          });
        });
      } else {
          const tr = tbody.insertRow();
          const td = tr.insertCell();
          td.colSpan = displayHeaders.length;
          td.textContent = 'データが見つかりません。';
      }

      container.appendChild(table);
      
      const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
      const endItem = Math.min(startItem + ITEMS_PER_PAGE - 1, totalItems);
      document.getElementById('results-count').textContent = `(${totalItems > 0 ? startItem + ' - ' + endItem + ' / ' : ''}${totalItems}件)`;
      renderPagination(totalItems);

    } catch (e) {
      handleError(e);
    }
  }
  
  function showPreview(element) {
    const mailId = element.dataset.mailId;
    const mailLink = element.dataset.mailLink;
    const id = element.dataset.id;
    const company = element.dataset.company;
    const name = element.dataset.name;

    const previewPane = document.getElementById('preview-pane');
    const iframe = document.getElementById('mail-preview');
    const infoDiv = document.getElementById('preview-info');
    const gmailBtn = document.getElementById('open-gmail-btn');

    infoDiv.innerHTML = '<div><span><strong>ID:</strong> ' + escapeHtml(id) + '</span> ' +
                         '<span><strong>社名:</strong> ' + escapeHtml(company) + '</span> ' +
                         '<span><strong>氏名/案件名:</strong> ' + escapeHtml(name) + '</span></div>' +
                         '<div style="margin-top: 5px;"><strong>件名:</strong> <span id="preview-subject" style="cursor: pointer;" title="クリックしてコピー">読み込み中...</span></div>';

    if (mailLink && mailLink.startsWith('http')) {
        gmailBtn.onclick = function() { window.open(mailLink, '_blank'); };
        gmailBtn.classList.remove('hidden');
    } else {
        gmailBtn.classList.add('hidden');
    }
    
    document.getElementById('left-pane').classList.add('shrunk');
    previewPane.classList.remove('hidden');
    iframe.srcdoc = "読み込み中...";
    
    if (mailId && !mailId.startsWith('http')) {
        google.script.run
          .withSuccessHandler(function(response) {
            const subjectSpan = document.getElementById('preview-subject');
            subjectSpan.textContent = response.subject;
            subjectSpan.onclick = function() { copyToClipboard(response.subject, subjectSpan); };

            const styledBody = '<style>' +
                'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }' +
                '</style>' + response.body;
            iframe.srcdoc = styledBody;
          })
          .withFailureHandler(function(error) {
              handleError(error);
              document.getElementById('preview-subject').textContent = '取得エラー';
          })
          .getMailBody(mailId);
    } else {
        document.getElementById('preview-subject').textContent = 'N/A';
        iframe.srcdoc = "このデータはURLからインポートされたため、メール本文のプレビューはありません。";
    }
  }

  function copyToClipboard(text, element) {
    navigator.clipboard.writeText(text).then(function() {
      const originalText = element.textContent;
      element.textContent = 'コピーしました！';
      setTimeout(function() {
        element.textContent = originalText;
      }, 1500);
    }, function(err) {
      console.error('クリップボードへのコピーに失敗しました: ', err);
      alert("コピーに失敗しました。ブラウザの設定を確認してください。");
    });
  }
  
  function handleDeleteOldData() {
    if(confirm('登録から14日以上経過したデータを全て削除します。よろしいですか？')) {
        showLoader(true);
        google.script.run
            .withSuccessHandler(function(response) {
                showLoader(false);
                alert(response.message);
                triggerSearch(1);
            })
            .withFailureHandler(handleError)
            .deleteOldData();
    }
  }

  function handleRefreshCache() {
    showLoader(true);
    google.script.run
        .withSuccessHandler(function(message) {
            alert(message);
            triggerSearch(1);
        })
        .withFailureHandler(handleError)
        .clearCache();
  }
  
  function handleMatching() {
    const matchType = document.querySelector('input[name="match_type"]:checked').value;
    const inputText = document.getElementById('matching-text').value;
    const sourceId = document.getElementById('matching-id').value;
    const maxResults = document.getElementById('max-matching-results').value;
    const additionalPrompt = document.getElementById('matching-prompt').value;
    if (!inputText.trim() && !sourceId.trim()) {
        alert('マッチング元の情報（IDまたはテキスト）を入力してください。');
        return;
    }
    
    isMatchingCancelled = false;
    document.getElementById('matching-btn').classList.add('hidden');
    document.getElementById('cancel-matching-btn').classList.remove('hidden');

    showLoader(true);
    const resultsDiv = document.getElementById('matching-results');
    resultsDiv.innerHTML = 'AIがマッチング候補を検索中です...';
    
    google.script.run
        .withSuccessHandler(function(response) {
            if (isMatchingCancelled) return;
            showLoader(false);
            document.getElementById('matching-btn').classList.remove('hidden');
            document.getElementById('cancel-matching-btn').classList.add('hidden');

            if (response.success) {
                displayMatchingResults(response.result);
            } else {
                resultsDiv.innerHTML = '<p style="color: red;">' + response.error + '</p>';
            }
        })
        .withFailureHandler(handleError)
        .performMatching(matchType, inputText, maxResults, additionalPrompt, sourceId);
  }
  
  function handleCancelMatching() {
    isMatchingCancelled = true;
    showLoader(false);
    document.getElementById('matching-btn').classList.remove('hidden');
    document.getElementById('cancel-matching-btn').classList.add('hidden');
    document.getElementById('matching-results').innerHTML = '<p>マッチングをキャンセルしました。</p>';
  }

  function displayMatchingResults(results) {
    const resultsDiv = document.getElementById('matching-results');
    if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<p>マッチする候補は見つかりませんでした。</p>';
        return;
    }
    
    const matchType = document.querySelector('input[name="match_type"]:checked').value;
    
    const ul = document.createElement('ul');
    const h3 = document.createElement('h3');
    h3.textContent = 'マッチング結果';
    
    results.forEach(function(item) {
        const fullData = item.fullData;
        if (!fullData) return;

        const id = fullData.ID || '';
        const company = fullData.社名 || '';
        const name = (matchType === 'jinzai') ? (fullData.案件名 || '') : (fullData.氏名 || '');
        const mailId = fullData.メールID || '';
        const mailLink = fullData.メールリンク || '';
        const reason = item.reason || '理由不明';

        const li = document.createElement('li');
        li.style.cursor = 'pointer';
        
        li.dataset.mailId = mailId;
        li.dataset.mailLink = mailLink;
        li.dataset.id = id;
        li.dataset.company = company;
        li.dataset.name = name;
        li.onclick = function() { showPreview(this); };
        
        const strong = document.createElement('strong');
        strong.textContent = '候補ID: ' + id;
        
        li.appendChild(strong);
        li.appendChild(document.createElement('br'));
        li.appendChild(document.createTextNode('理由: ' + reason));
        
        ul.appendChild(li);
    });
    
    resultsDiv.innerHTML = '';
    resultsDiv.appendChild(h3);
    resultsDiv.appendChild(ul);
  }

  function handleImport() {
    const urls = document.getElementById('import-urls').value;
    if (!urls.trim()) {
      alert('インポートするスプレッドシートのURLを入力してください。');
      return;
    }

    const loader = document.getElementById('import-loader');
    const resultsDiv = document.getElementById('import-results');
    const importBtn = document.getElementById('import-btn');

    loader.classList.remove('hidden');
    importBtn.disabled = true;
    resultsDiv.innerHTML = '';

    google.script.run
      .withSuccessHandler(function(response) {
        loader.classList.add('hidden');
        importBtn.disabled = false;
        resultsDiv.textContent = response.message;
        if (response.success) {
          if (response.totalImported > 0) {
            handleRefreshCache();
          }
        }
      })
      .withFailureHandler(function(error) {
        loader.classList.add('hidden');
        importBtn.disabled = false;
        resultsDiv.textContent = 'エラー: ' + error.message;
      })
      .importFromUrls(urls);
  }


  // ===============================================================
  // ユーティリティ関数
  // ===============================================================
  
  function handleResetSearch() {
    document.getElementById('search-form').reset();
    toggleFilters();
    triggerSearch(1);
  }

  function renderPagination(totalItems) {
    const paginationContainer = document.getElementById('pagination-controls');
    paginationContainer.innerHTML = '';
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

    if (totalPages <= 1) return;

    const prevButton = document.createElement('button');
    prevButton.textContent = '前へ';
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = function() { triggerSearch(currentPage - 1); };
    paginationContainer.appendChild(prevButton);

    const pageInfo = document.createElement('span');
    pageInfo.textContent = ' ' + currentPage + ' / ' + totalPages + ' ';
    paginationContainer.appendChild(pageInfo);

    const nextButton = document.createElement('button');
    nextButton.textContent = '次へ';
    nextButton.disabled = currentPage === totalPages;
    nextButton.onclick = function() { triggerSearch(currentPage + 1); };
    paginationContainer.appendChild(nextButton);
  }

  function updateMatchingPlaceholder() {
    const matchType = document.querySelector('input[name="match_type"]:checked').value;
    const promptInput = document.getElementById('matching-prompt');
    const idInput = document.getElementById('matching-id');
    const idLabel = document.getElementById('matching-id-label');

    if (matchType === 'jinzai') {
      promptInput.placeholder = '単価が70万円以上、もしくはスキル見合いの案件のみ抽出してください。また同一だと思われる案件は最も単価が高い案件のみ表示してください。';
      idLabel.textContent = 'IDで人材を指定:';
      idInput.placeholder = '人材DBのIDを入力';
    } else { // 'anken'
      promptInput.placeholder = '希望単価が60万円以下の要員のみ抽出してください。また同一人物だと思われる要員は単価が最も安い方のみ表示してください。';
      idLabel.textContent = 'IDで案件を指定:';
      idInput.placeholder = '案件DBのIDを入力';
    }
  }

  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  function formatDateTime(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return dateString;
        }
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const m = String(date.getMinutes()).padStart(2, '0');
        return yyyy + '/' + mm + '/' + dd + '\n' + h + ':' + m;
    } catch (e) {
        return dateString;
    }
  }

  function sanitizeHeaderForClass(header) {
    const map = {
      'ID': 'id', '受信日時': 'received-date', '社名': 'company', '氏名': 'name',
      '性別': 'gender', '国籍': 'nationality', '年齢': 'age', '最寄駅': 'station',
      '所属': 'affiliation', 'スキルタグ': 'skill-tags', 'スキルサマリー': 'skill-summary',
      '希望サマリー': 'wish-summary', '希望ポジション': 'desired-position', 'その他サマリー': 'other-summary',
      '単価': 'price',
      '案件名': 'project-name', '場所': 'location', 'スキル要件サマリー': 'skill-req-summary',
      '求めるポジション': 'required-position', '期間': 'period'
    };
    return map[header] || 'generic-col';
  }
  
  function showLoader(show) {
    const loader = document.getElementById('loader');
    const quoteEl = document.getElementById('motivational-quote');

    if (show) {
        const randomIndex = Math.floor(Math.random() * SALES_QUOTES.length);
        quoteEl.textContent = SALES_QUOTES[randomIndex];
        loader.classList.remove('hidden');
    } else {
        loader.classList.add('hidden');
    }
  }
  
  function handleError(error) {
    showLoader(false);
    const errorString = (typeof error === 'object' && error.message) ? error.message : error.toString();
    document.getElementById('results-table-container').innerHTML = 
        '<p style="color: red; font-weight: bold;">エラーが発生しました: ' + escapeHtml(errorString) + '</p>' +
        '<p>詳細は、ブラウザのデベロッパーツールのコンソールを確認してください。</p>';
  }
  
  function debounce(func, delay) {
    let timeout;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(timeout);
      timeout = setTimeout(function() {
        func.apply(context, args);
      }, delay);
    };
  }
</script>
</body>
</html>
